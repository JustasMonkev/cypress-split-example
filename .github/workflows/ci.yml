name: ci
on: push
jobs:
  test:
    runs-on: ubuntu-20.04
    strategy:
      matrix:
        environment: [desktop, mobile]
        test: [A1, A2, A3]
    steps:
      - name: Checkout 🛎
        uses: actions/checkout@v3

      - name: Install dependencies 🔍
        run: npm ci

      - name: Split tests across multiple machines 🤖
        id: prepare
        uses: bahmutov/gh-build-matrix@main
        with:
          n: 3 # number of chunks to split into
          items: ${{ matrix.environment }}:${{ matrix.test }}

      - name: Run Cypress tests 🧪
        # https://github.com/cypress-io/github-action
        uses: cypress-io/github-action@v5
        with:
          browser: chrome
        env:
          SPLIT: ${{ steps.prepare.outputs.matrix }}
          SPLIT_INDEX: ${{ matrix.index }}

  collect-results:
    needs: test
    runs-on: ubuntu-20.04
    steps:
      - name: Combine test results 🤝
        uses: peter-evans/create-pull-request-comment@v3.7.0
        with:
          commit-message: Add test results
          body: |
            ## Test Results

            ${{ join(needs.test.*.outputs.test-results, '\n') }}
