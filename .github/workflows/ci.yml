name: ci
on: push
jobs:
  # example running all tests on a single machine
  test:
    runs-on: ubuntu-20.04
    strategy:
      matrix:
        environment: [desktop, mobile]
        test: [A1, A2, A3]
    steps:
      - name: Checkout 🛎
        uses: actions/checkout@v3

      - name: Run Cypress tests 🧪
        # https://github.com/cypress-io/github-action
        uses: cypress-io/github-action@v5

  desktop-tests:
    runs-on: ubuntu-20.04
    needs: prepare
    steps:
      - name: Checkout 🛎
        uses: actions/checkout@v3

      - name: Install dependencies 🔧
        run: npm ci

      - name: Run Cypress tests on desktop 🖥️
        # https://github.com/cypress-io/github-action
        uses: cypress-io/github-action@v5
        with:
          spec: ${{ matrix.test }}
        env:
          CYPRESS_CACHE_FOLDER: ${{ runner.workspace }}/.cypress_cache
      strategy:
        matrix:
          include:
            - environment: desktop
              test: A1
            - environment: desktop
              test: A2
            - environment: desktop
              test: A3

  mobile-tests:
    runs-on: ubuntu-20.04
    needs: prepare
    steps:
      - name: Checkout 🛎
        uses: actions/checkout@v3

      - name: Install dependencies 🔧
        run: npm ci

      - name: Run Cypress tests on mobile 📱
        # https://github.com/cypress-io/github-action
        uses: cypress-io/github-action@v5
        with:
          spec: ${{ matrix.test }}
        env:
          CYPRESS_CACHE_FOLDER: ${{ runner.workspace }}/.cypress_cache
      strategy:
        matrix:
          include:
            - environment: mobile
              test: A1
            - environment: mobile
              test: A2
            - environment: mobile
              test: A3

  prepare:
    runs-on: ubuntu-20.04
    outputs:
      matrix: ${{ steps.generate-matrix.outputs.matrix }}
    steps:
      - name: Generate matrix 🔢
        id: generate-matrix
        run: |
          CHUNKS=2
          TESTS=(A1 A2 A3)
          TOTAL_TESTS=${#TESTS[@]}
          CHUNK_SIZE=$((TOTAL_TESTS / CHUNKS))
          for ((i=0; i<$CHUNKS; i++)); do
            START_INDEX=$((i * CHUNK_SIZE))
            END_INDEX=$((START_INDEX + CHUNK_SIZE - 1))
            if ((i == CHUNKS - 1)); then
              END_INDEX=$((TOTAL_TESTS - 1))
            fi
            echo "::set-output name=matrix::$i=${TESTS[@]:$START_INDEX:$((END_INDEX - START_INDEX + 1))}"
  combine-results:
    needs: [desktop-tests, mobile-tests]
    if: always()
    runs-on: ubuntu-20.04
    steps:
      - name: Combine test results 🤝
        uses: peter-evans/create-pull-request@v3.10.1
        with:
          commit-message: 'Combine test results'
          title: 'Combine test results'
          body: 'This is an automatic PR to combine test results.'
          branch: 'combine-results'
          base: 'main'
